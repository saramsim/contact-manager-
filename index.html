function extractContactFromRow(row, source) {
    console.log('Satır içeriği:', row);
    
    let firstName = '';
    let lastName = '';
    let phones = [];
    
    // Excel sütunlarını kontrol et
    for (let i = 0; i < row.length; i++) {
        const cell = row[i];
        if (!cell) continue;
        
        const cellStr = cell.toString().trim();
        if (!cellStr) continue;

        console.log(`Hücre ${i} (${getColumnName(i)}):`, cellStr);

        // Telefon numarası kontrolü (genellikle F sütunu - index 5)
        const cleanedDigits = cellStr.replace(/\D/g, '');
        if (cleanedDigits.length >= 10 && isPhoneNumber(cellStr)) {
            phones.push(cleanedDigits);
            console.log('Telefon bulundu:', cleanedDigits);
        }
        // İsim kontrolü - telefon değilse
        else if (isValidName(cellStr)) {
            // İlk geçerli isim hücresi (genellikle A sütunu)
            if (!firstName && i <= 2) {
                firstName = cellStr.trim();
                console.log('Ad bulundu:', firstName);
            }
            // İkinci geçerli isim hücresi (genellikle B sütunu) 
            else if (!lastName && i <= 3 && firstName) {
                lastName = cellStr.trim();
                console.log('Soyad bulundu:', lastName);
            }
        }
    }
    
    // İsmi birleştir
    let fullName = '';
    if (firstName && lastName) {
        fullName = `${firstName} ${lastName}`;
    } else if (firstName) {
        // Eğer firstName birden fazla kelime içeriyorsa (BERAT AHMET gibi)
        const words = firstName.split(/\s+/);
        if (words.length >= 2) {
            fullName = firstName; // Zaten tam isim
        } else {
            fullName = firstName; // Tek isim
        }
    } else if (lastName) {
        fullName = lastName;
    }
    
    console.log('Birleştirilmiş isim:', fullName);
    
    // Kişi oluştur
    if (phones.length > 0 && fullName) {
        const contact = {
            name: formatPersonName(fullName),
            phone: formatPhoneNumber(phones[0]),
            source: source
        };
        console.log('Excel kişisi oluşturuldu:', contact);
        return contact;
    } else if (phones.length > 0) {
        // İsim yoksa telefon son 4 hanesi ile varsayılan isim
        const contact = {
            name: `Bilinmeyen ${phones[0].substr(-4)}`,
            phone: formatPhoneNumber(phones[0]),
            source: source
        };
        console.log('İsimsiz Excel kişisi oluşturuldu:', contact);
        return contact;
    }

    console.log('Geçerli kişi bulunamadı - isim:', fullName, 'telefon sayısı:', phones.length);
    return null;
}

function isValidName(text) {
    if (!text || text.length < 2 || text.length > 50) return false;
    
    // Sadece sayı değil
    if (/^\d+$/.test(text)) return false;
    
    // En az bir harf içermeli
    if (!/[A-ZÇĞİÖŞÜa-zçğıöşü]/.test(text)) return false;
    
    // Çok fazla sayı içermemeli (telefon numarası olabilir)
    const digitCount = (text.match(/\d/g) || []).length;
    if (digitCount > text.length / 2) return false;
    
    // Email adresi değil
    if (text.includes('@')) return false;
    
    // URL değil
    if (text.includes('http') || text.includes('www.')) return false;
    
    // Özel durumlar - Excel'de sık görülen değerler
    const upperText = text.toUpperCase();
    if (upperText === 'SAYISAL' || upperText === 'B' || /^\d+$/.test(text)) {
        return false;
    }
    
    return true;
}

function formatPersonName(name) {
    if (!name) return '';
    
    return name
        .trim()
        .split(/\s+/)
        .map(word => {
            if (word.length === 0) return '';
            
            // Türkçe karakterler için özel formatıma
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        })
        .join(' ');
}

function extractContactsFromText(text, source) {
    const contacts = [];
    const lines = text.split(/[\n\r]+/);

    console.log('Metin satır sayısı:', lines.length);

    lines.forEach((line, index) => {
        const cleanLine = line.trim();
        if (!cleanLine || cleanLine.length < 3) return;

        console.log(`Satır ${index}:`, cleanLine);

        // Telefon arama - daha esnek pattern
        const phoneMatches = cleanLine.match(/[\+]?[\d\s\(\)\-\.]{10,}/g);
        
        if (phoneMatches) {
            phoneMatches.forEach(phoneMatch => {
                const cleanedDigits = phoneMatch.replace(/\D/g, '');
                if (cleanedDigits.length >= 10) {
                    const phone = cleanedDigits;
                    console.log('Telefon bulundu:', phone);

                    // İsim arama - telefonu çıkararak
                    let lineForName = cleanLine.replace(phoneMatch, '').trim();
                    
                    // Noktalama işaretlerini temizle
                    lineForName = lineForName.replace(/[.,;:!?()[\]{}'"]/g, ' ');
                    
                    // Birden fazla boşluğu tek boşluk yap
                    lineForName = lineForName.replace(/\s+/g, ' ').trim();
                    
                    let name = '';
                    
                    if (lineForName.length >= 2) {
                        // Kelimeler halinde ayır ve filtrele
                        const words = lineForName.split(/\s+/).filter(word => 
                            word.length >= 2 && 
                            /[A-ZÇĞİÖŞÜa-zçğıöşü]/.test(word) &&
                            !/^\d+$/.test(word)
                        );
                        
                        console.log('Bulunan kelimeler:', words);
                        
                        if (words.length >= 2) {
                            // İlk iki kelimeyi birleştir (ad soyad)
                            name = words.slice(0, 2).join(' ');
                        } else if (words.length === 1) {
                            // Tek kelime varsa onu kullan
                            name = words[0];
                        } else {
                            // Kelime bulunamadıysa orijinal metni temizleyerek dene
                            const cleanedLine = lineForName.replace(/[^A-ZÇĞİÖŞÜa-zçğıöşü\s]/g, '').trim();
                            if (cleanedLine.length >= 2) {
                                name = cleanedLine;
                            }
                        }
                    }
                    
                    // Hala isim yoksa varsayılan
                    if (!name || name.length < 2) {
                        name = `Bilinmeyen ${phone.substr(-4)}`;
                    }
                    
                    console.log('Bulunan isim:', name);

                    const contact = {
                        name: formatPersonName(name),
                        phone: formatPhoneNumber(phone),
                        source: source
                    };
                    console.log('Metin kişisi oluşturuldu:', contact);
                    contacts.push(contact);
                }
            });
        }
    });

    console.log('Toplam bulunan kişi:', contacts.length);
    return contacts;
}

// Yardımcı fonksiyonlar
function getColumnName(index) {
    const columns = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    return columns[index] || `Col${index}`;
}

function isPhoneNumber(text) {
    const digits = text.replace(/\D/g, '');
    return digits.length >= 10 && digits.length <= 15;
}

function cleanPhoneNumber(phone) {
    return phone.replace(/\D/g, '');
}

function formatPhoneNumber(phone) {
    const cleaned = phone.replace(/\D/g, '');
    
    if (cleaned.length === 10) {
        // 5XXXXXXXXX formatı
        return `(${cleaned.substr(0, 3)}) ${cleaned.substr(3, 3)} ${cleaned.substr(6, 2)} ${cleaned.substr(8, 2)}`;
    } else if (cleaned.length === 11 && cleaned.startsWith('0')) {
        // 05XXXXXXXXX formatı
        return `${cleaned.substr(0, 4)} ${cleaned.substr(4, 3)} ${cleaned.substr(7, 2)} ${cleaned.substr(9, 2)}`;
    } else if (cleaned.length === 13 && cleaned.startsWith('90')) {
        // 905XXXXXXXXX formatı
        return `+${cleaned.substr(0, 2)} ${cleaned.substr(2, 3)} ${cleaned.substr(5, 3)} ${cleaned.substr(8, 2)} ${cleaned.substr(10, 2)}`;
    }
    
    return cleaned;
}
